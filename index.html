<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Snake Nokia ‚Äî Mobile (FX + Autosize + Record + Mireille)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --text:#e8eef6; --muted:#9fb0c3;
      --glow: rgba(80,170,255,.22);
      --glow2: rgba(120,255,170,.22);
      --danger: rgba(255,90,90,.22);
    }
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    button{touch-action: manipulation;}

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: max(10px, env(safe-area-inset-top)) 10px max(12px, env(safe-area-inset-bottom));
      gap:10px;
      max-width:720px;
      margin:0 auto;
      position:relative;
    }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .title{font-weight:900; letter-spacing:.2px;}
    .hud{display:flex; gap:10px; align-items:center; font-variant-numeric:tabular-nums; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .stage{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(120% 120% at 50% 20%, rgba(80,170,255,.08), rgba(0,0,0,0) 60%),
        radial-gradient(140% 140% at 20% 90%, rgba(120,255,170,.06), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      overflow:hidden;
      position:relative;
      min-height: 210px;
      height: clamp(235px, 38vh, 420px);
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      image-rendering: pixelated;
    }

    .bottom{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      overflow:hidden;
    }

    .actionsRow{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      padding: 0 6px;
    }

    .iconBtn{
      width: clamp(62px, 18vw, 76px);
      height: clamp(62px, 18vw, 76px);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .iconBtn:active{ transform: scale(.98); }
    .icon{ font-size:22px; line-height:1; }
    .iconLabel{ font-size:12px; color:rgba(232,238,246,.92); line-height:1; }
    .iconBtn.primary{
      background:rgba(80,170,255,.22);
      border-color:rgba(80,170,255,.35);
    }
    .iconBtn.flash{
      animation: btnPulse .22s ease-out;
    }
    @keyframes btnPulse{
      0%{ transform: scale(1); filter: brightness(1); }
      50%{ transform: scale(1.03); filter: brightness(1.35); }
      100%{ transform: scale(1); filter: brightness(1); }
    }

    .dpadBig{
      width: clamp(190px, 62vw, 270px);
      max-width: 92vw;
      aspect-ratio: 1 / 1;
      max-height: min(34vh, 320px);
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: clamp(10px, 2.5vw, 14px);
      padding: clamp(10px, 2.8vw, 14px);
      border-radius:22px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    .dpadBig button{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size: clamp(22px, 6vw, 28px);
      user-select:none;
      min-height: 0;
      box-shadow: inset 0 0 0 rgba(0,0,0,0);
      transition: transform .05s ease, background .2s ease;
    }
    .dpadBig button:active{
      transform: scale(.98);
      background:rgba(255,255,255,.10);
    }

    .hint{
      width:100%;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      padding:0 2px;
      text-align:center;
    }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      z-index:50;
    }
    .modal{
      width:min(560px, 95vw);
      background:var(--panel);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow:0 22px 80px rgba(0,0,0,.7);
      text-align:center;
    }
    .modal h2{ margin:8px 0 8px; font-size:22px;}
    .modal p{ margin:6px 0; color:var(--muted);}
    .bigScore{ font-size:46px; font-weight:900; margin:10px 0 2px; font-variant-numeric:tabular-nums;}
    .recordLine{
      margin-top:10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-variant-numeric:tabular-nums;
      color:rgba(232,238,246,.95);
      flex-wrap:wrap;
    }
    .encourage{
      margin-top:10px;
      font-size:16px;
      color:rgba(232,238,246,.92);
      line-height:1.35;
    }
    .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:14px;}
    .btnRow .bigBtn{
      min-width:200px;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:16px;
      user-select:none;
      box-shadow: 0 14px 45px rgba(0,0,0,.45);
      transition: transform .05s ease, filter .2s ease;
    }
    .btnRow .bigBtn.primary{
      background:rgba(80,170,255,.22);
      border-color:rgba(80,170,255,.35);
    }
    .btnRow .bigBtn:active{ transform: scale(.99); }

    @media (orientation: landscape){
      .stage{ height: clamp(210px, 55vh, 380px); }
      .dpadBig{
        width: clamp(170px, 40vw, 230px);
        max-height: min(48vh, 260px);
      }
      .iconBtn{ width: clamp(56px, 12vw, 66px); height: clamp(56px, 12vw, 66px); }
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="top">
      <div class="title">üêç Snake (Nokia) ‚Äî Mobile</div>
      <div class="hud">
        <div class="pill">Score : <span id="score">0</span></div>
        <div class="pill">Vitesse : <span id="speed">1.0√ó</span></div>
        <div class="pill">Record : <span id="bestHud">0</span></div>
      </div>
    </div>

    <div class="stage">
      <canvas id="game" width="480" height="480" aria-label="Jeu Snake"></canvas>
    </div>

    <div class="bottom">
      <div class="actionsRow" aria-label="Actions">
        <button class="iconBtn" id="pauseBtn" aria-label="Pause">
          <div class="icon">‚è∏</div><div class="iconLabel">Pause</div>
        </button>
        <button class="iconBtn" id="fsBtnSmall" aria-label="Plein √©cran">
          <div class="icon">‚õ∂</div><div class="iconLabel">Plein √©cran</div>
        </button>
        <button class="iconBtn" id="startSmall" aria-label="D√©marrer">
          <div class="icon">‚ñ∂</div><div class="iconLabel">D√©marrer</div>
        </button>
        <button class="iconBtn primary" id="restartSmall" aria-label="Recommencer">
          <div class="icon">‚Üª</div><div class="iconLabel">Rejouer</div>
        </button>
      </div>

      <div class="dpadBig" aria-label="Contr√¥les directionnels">
        <div></div>
        <button id="upBtn" aria-label="Haut">‚ñ≤</button>
        <div></div>
        <button id="leftBtn" aria-label="Gauche">‚óÄ</button>
        <button id="noopBtn" disabled aria-label="Centre">‚óè</button>
        <button id="rightBtn" aria-label="Droite">‚ñ∂</button>
        <div></div>
        <button id="downBtn" aria-label="Bas">‚ñº</button>
        <div></div>
      </div>

      <div class="hint">D√©part tr√®s lent ‚Ä¢ Acc√©l√©ration douce ‚Ä¢ FX partout ‚Ä¢ Record sauvegard√© ‚Ä¢ Message pour Mireille</div>
    </div>

    <div class="overlay" id="startOverlay">
      <div class="modal">
        <div style="font-size:42px; line-height:1;">üêç</div>
        <h2>Snake ‚Äî pr√™t ?</h2>
        <p>Contr√¥les grands + mode portrait.</p>
        <div class="btnRow">
          <button class="bigBtn" id="fsBtn">‚õ∂ Plein √©cran</button>
          <button class="bigBtn primary" id="startBtn">‚ñ∂ D√©marrer</button>
        </div>
        <p style="margin-top:10px; font-size:12px; color:var(--muted);">
          Sur certains navigateurs (iOS), le plein √©cran peut √™tre limit√©.
        </p>
      </div>
    </div>

    <div class="overlay" id="overOverlay">
      <div class="modal">
        <div style="font-size:36px; line-height:1;">üíÄ</div>
        <h2>Game Over</h2>
        <div class="bigScore" id="finalScore">0</div>
        <p>Score final</p>

        <div class="recordLine">
          üèÜ Record : <b><span id="bestOver">0</span></b>
          <span style="opacity:.8;">‚Ä¢</span>
          √Ä battre : <b><span id="toBeat">0</span></b>
        </div>

        <div class="encourage" id="encourageMsg"></div>
        <div class="btnRow">
          <button class="bigBtn primary" id="restartBtn">‚Üª Recommencer</button>
          <button class="bigBtn" id="closeOverBtn">Voir le plateau</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const appRoot = document.getElementById("appRoot");

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");

      const scoreEl = document.getElementById("score");
      const speedEl = document.getElementById("speed");
      const bestHudEl = document.getElementById("bestHud");

      const startOverlay = document.getElementById("startOverlay");
      const overOverlay = document.getElementById("overOverlay");
      const finalScoreEl = document.getElementById("finalScore");
      const encourageMsgEl = document.getElementById("encourageMsg");
      const bestOverEl = document.getElementById("bestOver");
      const toBeatEl = document.getElementById("toBeat");

      const startBtn = document.getElementById("startBtn");
      const startSmall = document.getElementById("startSmall");
      const fsBtn = document.getElementById("fsBtn");
      const fsBtnSmall = document.getElementById("fsBtnSmall");
      const pauseBtn = document.getElementById("pauseBtn");
      const restartBtn = document.getElementById("restartBtn");
      const restartSmall = document.getElementById("restartSmall");
      const closeOverBtn = document.getElementById("closeOverBtn");

      const upBtn = document.getElementById("upBtn");
      const downBtn = document.getElementById("downBtn");
      const leftBtn = document.getElementById("leftBtn");
      const rightBtn = document.getElementById("rightBtn");

      // ====== Best score persistence ======
      const BEST_KEY = "snake_best_score_v1";
      function loadBest() {
        const v = Number(localStorage.getItem(BEST_KEY));
        return Number.isFinite(v) && v >= 0 ? Math.floor(v) : 0;
      }
      function saveBest(v) {
        localStorage.setItem(BEST_KEY, String(Math.max(0, Math.floor(v))));
      }
      let bestScore = loadBest();
      bestHudEl.textContent = bestScore;

      // ====== SFX (no files) ======
      let audioCtx = null;
      function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      function beep({freq=440, dur=0.08, type="square", vol=0.08, freqEnd=null} = {}) {
        if (!audioCtx) return;
        const t0 = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, t0);
        if (freqEnd !== null) o.frequency.exponentialRampToValueAtTime(Math.max(1, freqEnd), t0 + dur);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(vol, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t0); o.stop(t0 + dur + 0.01);
      }
      function noisePop(dur=0.08, vol=0.06){
        if (!audioCtx) return;
        const t0 = audioCtx.currentTime;
        const bufferSize = Math.floor(audioCtx.sampleRate * dur);
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i=0;i<bufferSize;i++){
          const t = i/bufferSize;
          data[i] = (Math.random()*2-1) * (1 - t) * (1 - t);
        }
        const src = audioCtx.createBufferSource();
        const g = audioCtx.createGain();
        g.gain.value = vol;
        src.buffer = buffer;
        src.connect(g); g.connect(audioCtx.destination);
        src.start(t0);
        src.stop(t0 + dur);
      }

      const SFX = {
        click() { beep({freq:700, dur:0.05, type:"square", vol:0.05, freqEnd:520}); },
        apple() { beep({freq:980, dur:0.07, type:"square", vol:0.09, freqEnd:1560}); noisePop(0.06, 0.04); },
        turn()  { beep({freq:520, dur:0.028, type:"square", vol:0.03, freqEnd:430}); },
        best()  {
          beep({freq:880, dur:0.07, type:"square", vol:0.09, freqEnd:1320});
          setTimeout(()=>beep({freq:1320, dur:0.09, type:"square", vol:0.09, freqEnd:1760}), 70);
          setTimeout(()=>beep({freq:1760, dur:0.08, type:"square", vol:0.08, freqEnd:1320}), 160);
        },
        death() {
          noisePop(0.16, 0.08);
          beep({freq:420, dur:0.11, type:"sawtooth", vol:0.10, freqEnd:160});
          setTimeout(()=>beep({freq:240, dur:0.14, type:"square", vol:0.09, freqEnd:90}), 90);
        },
      };

      function unlockAudioFromUserGesture() {
        initAudio();
        if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
      }

      // ====== Mireille messages ======
      const MIREILLE_MESSAGES = [
        "Mireille, c‚Äô√©tait une belle tentative ! La prochaine pomme est pour toi üçé",
        "Allez Mireille, on respire‚Ä¶ et on repart ! Tu vas y arriver üí™",
        "Mireille, tu progresses ! Chaque partie te rend plus forte üêç",
        "Bravo Mireille : m√™me quand on perd, on apprend. Rejoue ! ‚ú®",
        "Mireille, pas grave ! Le snake a juste fait sa diva üòÑ Recommence !",
        "Mireille, joli score ! Encore une et tu bats ton record üèÜ",
        "Courage Mireille : une petite pause‚Ä¶ puis un grand comeback üöÄ",
        "Mireille, tu g√®res ! La prochaine partie sera la bonne üî•",
        "Mireille, focus : doucement au d√©but, ensuite tu acc√©l√®res üòé",
        "Mireille, tu es plus maligne que ces murs. Revanche ! üòÅ"
      ];
      let lastMsgIndex = -1;
      function pickMireilleMessage() {
        let i;
        do { i = Math.floor(Math.random() * MIREILLE_MESSAGES.length); }
        while (i === lastMsgIndex);
        lastMsgIndex = i;
        return MIREILLE_MESSAGES[i];
      }

      // ====== Gameplay speed tuning (your request) ======
      // - Start 5x slower than before
      // - Speed progression 2x less aggressive
      const GRID = 20;
      const BASE_TICK_MS = 725;     // was ~145 -> now 5x slower
      const SPEED_UP_PER_APPLE = 0.965; // was ~0.93 -> now gentler (about 2x less aggressive)
      const MIN_TICK_MS = 120;      // keep it playable but not insane

      // ====== FX system (particles + screenshake + glow) ======
      const particles = [];
      let shakeT = 0;
      let shakeMag = 0;
      let flashT = 0;
      let speedPulseT = 0;

      function addShake(mag=6, t=140){
        shakeMag = Math.max(shakeMag, mag);
        shakeT = Math.max(shakeT, t);
      }
      function addFlash(t=120){ flashT = Math.max(flashT, t); }
      function addSpeedPulse(t=220){ speedPulseT = Math.max(speedPulseT, t); }

      function spawnBurst(cx, cy, count, kind){
        // cx,cy in pixels
        for (let i=0;i<count;i++){
          const a = Math.random()*Math.PI*2;
          const sp = (kind==="apple"? (2.2+Math.random()*3.8) : (1.2+Math.random()*2.4));
          particles.push({
            x: cx, y: cy,
            vx: Math.cos(a)*sp,
            vy: Math.sin(a)*sp,
            life: kind==="death" ? (520+Math.random()*240) : (320+Math.random()*220),
            age: 0,
            r: kind==="apple" ? (2.0+Math.random()*3.0) : (1.5+Math.random()*2.5),
            kind
          });
        }
      }

      // ---- Game state ----
      let snake, dir, nextDir, apple, score, tickMs, running, paused, lastTime, acc;

      function randCell() {
        return { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
      }
      function cellEquals(a,b){ return a.x===b.x && a.y===b.y; }

      function resizeCanvasForPortrait() {
        const stage = canvas.parentElement;
        const w = stage.clientWidth;
        const internal = GRID * 24; // 480 internal
        canvas.width = internal;
        canvas.height = internal;
        const sizeCSS = Math.min(w, stage.clientHeight, 520);
        canvas.style.width = sizeCSS + "px";
        canvas.style.height = sizeCSS + "px";
      }

      function placeApple() {
        let c;
        do { c = randCell(); } while (snake.some(seg => cellEquals(seg, c)));
        apple = c;
      }

      function setSpeedHud() {
        const mult = (BASE_TICK_MS / tickMs);
        speedEl.textContent = mult.toFixed(1) + "√ó";
      }

      function showStart() { startOverlay.style.display = "flex"; }
      function hideStart() { startOverlay.style.display = "none"; }
      function showGameOver() { overOverlay.style.display = "flex"; }
      function hideGameOver() { overOverlay.style.display = "none"; }

      function pxForCell(c){
        const cell = canvas.width / GRID;
        return { x: c.x*cell + cell/2, y: c.y*cell + cell/2, cell };
      }

      function resetGameState() {
        const start = { x: Math.floor(GRID/2), y: Math.floor(GRID/2) };
        snake = [
          { x: start.x, y: start.y },
          { x: start.x-1, y: start.y },
          { x: start.x-2, y: start.y },
        ];
        dir = { x: 0, y: 1 };
        nextDir = { x: 0, y: 1 };
        score = 0;
        tickMs = BASE_TICK_MS;
        paused = false;
        lastTime = 0;
        acc = 0;

        particles.length = 0;
        shakeT = 0; shakeMag = 0;
        flashT = 0; speedPulseT = 0;

        scoreEl.textContent = score;
        setSpeedHud();
        placeApple();
      }

      function setPauseBtnLabel(isPaused) {
        if (isPaused) {
          pauseBtn.innerHTML = '<div class="icon">‚ñ∂</div><div class="iconLabel">Reprendre</div>';
        } else {
          pauseBtn.innerHTML = '<div class="icon">‚è∏</div><div class="iconLabel">Pause</div>';
        }
      }

      function resetGame(showStartScreen = true) {
        resetGameState();
        running = false;
        hideGameOver();
        setPauseBtnLabel(false);
        render(16);
        if (showStartScreen) showStart();
        else hideStart();
      }

      function btnFlash(el){
        el.classList.remove("flash");
        void el.offsetWidth;
        el.classList.add("flash");
      }

      function startGame() {
        unlockAudioFromUserGesture();
        SFX.click();
        btnFlash(startSmall);
        hideStart();
        hideGameOver();
        running = true;
        paused = false;
        setPauseBtnLabel(false);
        addFlash(90);
      }

      function updateBestIfNeeded() {
        if (score > bestScore) {
          bestScore = score;
          saveBest(bestScore);
          bestHudEl.textContent = bestScore;
          SFX.best();
          addFlash(180);
          addShake(8, 180);
          return true;
        }
        return false;
      }

      function gameOver() {
        running = false;
        paused = false;
        setPauseBtnLabel(false);

        const newRecord = updateBestIfNeeded();

        finalScoreEl.textContent = score;
        bestOverEl.textContent = bestScore;
        toBeatEl.textContent = bestScore + 1;
        encourageMsgEl.textContent = newRecord
          ? "Mireille, NOUVEAU RECORD ! Magnifique üéâ Recommence pour le pulv√©riser !"
          : pickMireilleMessage();

        const headPx = pxForCell(snake[0]);
        spawnBurst(headPx.x, headPx.y, 70, "death");
        addShake(14, 260);
        addFlash(220);

        showGameOver();
        if (!newRecord) SFX.death();
      }

      function trySetDir(nx, ny) {
        if (nx === -dir.x && ny === -dir.y) return;
        nextDir = { x: nx, y: ny };
        if (running && !paused) SFX.turn();
      }

      function step() {
        dir = nextDir;
        const head = snake[0];
        const newHead = { x: head.x + dir.x, y: head.y + dir.y };

        if (newHead.x < 0 || newHead.x >= GRID || newHead.y < 0 || newHead.y >= GRID) return gameOver();
        if (snake.some(seg => cellEquals(seg, newHead))) return gameOver();

        snake.unshift(newHead);

        if (cellEquals(newHead, apple)) {
          score += 1;
          scoreEl.textContent = score;

          // FX on apple
          const ap = pxForCell(apple);
          spawnBurst(ap.x, ap.y, 28, "apple");
          addShake(5, 120);
          addFlash(70);
          addSpeedPulse(220);

          SFX.apple();

          // gentler speed progression (2x less aggressive)
          tickMs = Math.max(MIN_TICK_MS, Math.floor(tickMs * SPEED_UP_PER_APPLE));
          setSpeedHud();
          placeApple();
        } else {
          snake.pop();
        }
      }

      function clear() { ctx.clearRect(0,0,canvas.width,canvas.height); }

      function drawGrid(dt) {
        const cell = canvas.width / GRID;
        const t = performance.now() * 0.001;

        // subtle animated glow lines
        ctx.save();
        ctx.globalAlpha = 0.10 + 0.03*Math.sin(t*0.8);
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 1;
        for (let i = 1; i < GRID; i++) {
          ctx.beginPath(); ctx.moveTo(i*cell, 0); ctx.lineTo(i*cell, canvas.height); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(0, i*cell); ctx.lineTo(canvas.width, i*cell); ctx.stroke();
        }
        ctx.restore();
      }

      function drawCell(x,y,fill,stroke, glow=false){
        const cell = canvas.width / GRID;
        const px = x*cell, py = y*cell;

        if (glow){
          ctx.save();
          ctx.shadowColor = fill;
          ctx.shadowBlur = 14;
          ctx.fillStyle = fill;
          ctx.fillRect(px+1, py+1, cell-2, cell-2);
          ctx.restore();
        } else {
          ctx.fillStyle = fill;
          ctx.fillRect(px+1, py+1, cell-2, cell-2);
        }

        if (stroke){
          ctx.strokeStyle = stroke;
          ctx.lineWidth = 2;
          ctx.strokeRect(px+2, py+2, cell-4, cell-4);
        }
      }

      function drawApple(dt){
        const cell = canvas.width / GRID;
        const px = apple.x*cell, py = apple.y*cell;

        const t = performance.now()*0.001;
        const pulse = 0.5 + 0.5*Math.sin(t*5.5);
        const glow = 10 + 12*pulse;

        // glow ring
        ctx.save();
        ctx.globalAlpha = 0.16 + 0.12*pulse;
        ctx.fillStyle = "rgba(255,90,90,1)";
        ctx.shadowColor = "rgba(255,90,90,1)";
        ctx.shadowBlur = glow;
        ctx.beginPath();
        ctx.roundRect(px+4, py+4, cell-8, cell-8, 6);
        ctx.fill();
        ctx.restore();

        drawCell(apple.x, apple.y, "rgba(255,90,90,.92)", "rgba(255,255,255,.15)", true);
      }

      function updateAndDrawParticles(dt){
        if (!particles.length) return;
        for (let i=particles.length-1;i>=0;i--){
          const p = particles[i];
          p.age += dt;
          const k = p.kind;

          p.vx *= 0.985;
          p.vy *= 0.985;
          p.vy += (k==="death" ? 0.010 : 0.006) * dt;

          p.x += p.vx * (dt*0.6);
          p.y += p.vy * (dt*0.6);

          const life = p.life;
          const a = Math.max(0, 1 - p.age/life);

          ctx.save();
          ctx.globalAlpha = (k==="death" ? 0.35 : 0.55) * a;
          ctx.fillStyle = k==="death" ? "rgba(255,90,90,1)" : "rgba(120,255,170,1)";
          ctx.shadowColor = ctx.fillStyle;
          ctx.shadowBlur = (k==="death" ? 10 : 12) * a;

          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r*(0.6+0.7*a), 0, Math.PI*2);
          ctx.fill();
          ctx.restore();

          if (p.age >= life) particles.splice(i,1);
        }
      }

      function render(dt=16) {
        clear();

        // screenshake
        let sx = 0, sy = 0;
        if (shakeT > 0){
          shakeT = Math.max(0, shakeT - dt);
          const f = shakeT / 260;
          const mag = shakeMag * (0.25 + 0.75*f);
          sx = (Math.random()*2-1) * mag;
          sy = (Math.random()*2-1) * mag;
          if (shakeT === 0) shakeMag = 0;
        }

        ctx.save();
        ctx.translate(sx, sy);

        drawGrid(dt);
        drawApple(dt);

        // snake trail shimmer
        const t = performance.now()*0.001;
        const headGlow = 12 + 8*Math.sin(t*3.2);

        for (let i = snake.length - 1; i >= 0; i--) {
          const s = snake[i];
          const tailFade = 0.35 + 0.65*(1 - i/Math.max(1, snake.length-1));
          if (i === 0) {
            // head
            ctx.save();
            ctx.shadowColor = "rgba(120,255,170,1)";
            ctx.shadowBlur = headGlow + (speedPulseT>0 ? 10 : 0);
            ctx.restore();
            drawCell(s.x, s.y, "rgba(120,255,170,.96)", "rgba(255,255,255,.20)", true);
          } else {
            drawCell(s.x, s.y, `rgba(120,255,170,${0.25 + 0.55*tailFade})`, "rgba(0,0,0,.10)", false);
          }
        }

        // particles above everything
        updateAndDrawParticles(dt);

        // flash overlay
        if (flashT > 0){
          flashT = Math.max(0, flashT - dt);
          const a = flashT / 220;
          ctx.save();
          ctx.globalAlpha = 0.22 * a;
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(-50, -50, canvas.width+100, canvas.height+100);
          ctx.restore();
        }

        // speed pulse ring
        if (speedPulseT > 0){
          speedPulseT = Math.max(0, speedPulseT - dt);
          const a = 1 - (speedPulseT / 220);
          const ap = pxForCell(snake[0]);
          ctx.save();
          ctx.globalAlpha = 0.22*(1-a);
          ctx.strokeStyle = "rgba(80,170,255,1)";
          ctx.lineWidth = 3;
          ctx.shadowColor = "rgba(80,170,255,1)";
          ctx.shadowBlur = 16*(1-a);
          ctx.beginPath();
          ctx.arc(ap.x, ap.y, 10 + 55*a, 0, Math.PI*2);
          ctx.stroke();
          ctx.restore();
        }

        // pause overlay on canvas
        if (paused && running) {
          ctx.save();
          ctx.fillStyle = "rgba(0,0,0,.48)";
          ctx.fillRect(-50, -50, canvas.width+100, canvas.height+100);
          ctx.fillStyle = "#ffffff";
          ctx.shadowColor = "rgba(80,170,255,1)";
          ctx.shadowBlur = 18;
          ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "center";
          ctx.fillText("PAUSE", canvas.width/2, canvas.height/2);
          ctx.restore();
        }

        ctx.restore();

        // decay speedPulse
        if (speedPulseT > 0) { /* handled above */ }
      }

      function loop(t){
        if (!lastTime) lastTime = t;
        const dt = t - lastTime;
        lastTime = t;

        if (running && !paused) {
          acc += dt;
          while (acc >= tickMs) {
            acc -= tickMs;
            step();
            if (!running) break;
          }
        }
        render(dt);
        requestAnimationFrame(loop);
      }

      async function toggleFullscreen() {
        unlockAudioFromUserGesture();
        SFX.click();
        try {
          if (!document.fullscreenElement) {
            await appRoot.requestFullscreen?.();
          } else {
            await document.exitFullscreen?.();
          }
        } catch (e) {
          alert("Plein √©cran non disponible sur ce navigateur.\nAstuce: sur iPhone, essaye 'Ajouter √† l‚Äô√©cran d‚Äôaccueil'.");
        }
      }

      function bindPress(btn, fn){
        const start = (ev) => { ev.preventDefault(); unlockAudioFromUserGesture(); fn(); };
        btn.addEventListener("pointerdown", start, { passive:false });
      }
      bindPress(upBtn,   () => trySetDir(0,-1));
      bindPress(downBtn, () => trySetDir(0, 1));
      bindPress(leftBtn, () => trySetDir(-1,0));
      bindPress(rightBtn,() => trySetDir(1, 0));

      function btnFlash(el){
        el.classList.remove("flash");
        void el.offsetWidth;
        el.classList.add("flash");
      }

      startBtn.addEventListener("click", () => { btnFlash(startBtn); startGame(); });
      startSmall.addEventListener("click", () => { btnFlash(startSmall); startGame(); });

      fsBtn.addEventListener("click", () => { btnFlash(fsBtn); toggleFullscreen(); });
      fsBtnSmall.addEventListener("click", () => { btnFlash(fsBtnSmall); toggleFullscreen(); });

      pauseBtn.addEventListener("click", () => {
        unlockAudioFromUserGesture();
        SFX.click();
        btnFlash(pauseBtn);
        if (!running) return;
        paused = !paused;
        setPauseBtnLabel(paused);
        addFlash(60);
      });

      function doRestartImmediate() {
        unlockAudioFromUserGesture();
        SFX.click();
        btnFlash(restartSmall);
        btnFlash(restartBtn);
        resetGame(false);
        startGame();
      }
      restartBtn.addEventListener("click", doRestartImmediate);
      restartSmall.addEventListener("click", doRestartImmediate);

      closeOverBtn.addEventListener("click", () => {
        unlockAudioFromUserGesture();
        SFX.click();
        btnFlash(closeOverBtn);
        overOverlay.style.display = "none";
      });

      window.addEventListener("resize", resizeCanvasForPortrait);
      window.addEventListener("orientationchange", resizeCanvasForPortrait);

      // polyfill for roundRect on older browsers
      if (!CanvasRenderingContext2D.prototype.roundRect){
        CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
          r = Math.min(r, w/2, h/2);
          this.beginPath();
          this.moveTo(x+r, y);
          this.arcTo(x+w, y, x+w, y+h, r);
          this.arcTo(x+w, y+h, x, y+h, r);
          this.arcTo(x, y+h, x, y, r);
          this.arcTo(x, y, x+w, y, r);
          this.closePath();
          return this;
        };
      }

      // init
      setTimeout(() => {
        resizeCanvasForPortrait();
        resetGame(true);
        requestAnimationFrame(loop);
      }, 0);
    })();
  </script>
</body>
</html>
```Ó®Å0Ó®Ç
