<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Snake Nokia ‚Äî Mobile (Record + Mireille)</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#0f1620; --text:#e8eef6; --muted:#9fb0c3; }
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    button{touch-action: manipulation;}

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: max(10px, env(safe-area-inset-top)) 10px max(10px, env(safe-area-inset-bottom));
      gap:10px;
      max-width:720px;
      margin:0 auto;
      position:relative;
    }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .title{font-weight:800; letter-spacing:.2px;}
    .hud{display:flex; gap:10px; align-items:center; font-variant-numeric:tabular-nums; flex-wrap:wrap; justify-content:flex-end;}
    .pill{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); padding:6px 10px; border-radius:999px; white-space:nowrap;}

    .stage{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(120% 120% at 50% 20%, rgba(80,170,255,.06), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      overflow:hidden;
      position:relative;
      min-height: 220px;
      height: clamp(280px, 42vh, 430px);
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      image-rendering: pixelated;
    }

    .bottom{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .actionsRow{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .iconBtn{
      width:72px;
      height:72px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
    }
    .iconBtn:active{ transform: scale(.99); }
    .icon{
      font-size:22px;
      line-height:1;
    }
    .iconLabel{
      font-size:12px;
      color:rgba(232,238,246,.92);
      line-height:1;
    }
    .iconBtn.primary{
      background:rgba(80,170,255,.22);
      border-color:rgba(80,170,255,.35);
    }

    .dpadBig{
      width: 270px;
      max-width: 88vw;
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:14px;
      padding:14px;
      border-radius:22px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .dpadBig button{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:28px;
      user-select:none;
      min-height:70px;
    }
    .dpadBig button:active{ transform: scale(.98); background:rgba(255,255,255,.10); }

    .hint{
      width:100%;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      padding:0 2px;
      text-align:center;
    }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.58);
      backdrop-filter: blur(6px);
      z-index:50;
    }
    .modal{
      width:min(560px, 95vw);
      background:var(--panel);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow:0 22px 70px rgba(0,0,0,.6);
      text-align:center;
    }
    .modal h2{ margin:8px 0 8px; font-size:22px;}
    .modal p{ margin:6px 0; color:var(--muted);}
    .bigScore{ font-size:46px; font-weight:900; margin:10px 0 2px; font-variant-numeric:tabular-nums;}
    .recordLine{
      margin-top:10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-variant-numeric:tabular-nums;
      color:rgba(232,238,246,.95);
    }
    .encourage{
      margin-top:10px;
      font-size:16px;
      color:rgba(232,238,246,.92);
      line-height:1.35;
    }
    .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:14px;}
    .btnRow .bigBtn{
      min-width:200px;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:16px;
      user-select:none;
    }
    .btnRow .bigBtn.primary{
      background:rgba(80,170,255,.22);
      border-color:rgba(80,170,255,.35);
    }
    .btnRow .bigBtn:active{ transform: scale(.99); }

    @media (orientation: landscape){
      .stage{ height: clamp(220px, 60vh, 380px); }
      .dpadBig{ width:220px; }
      .iconBtn{ width:64px; height:64px; }
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="top">
      <div class="title">üêç Snake (Nokia) ‚Äî Mobile</div>
      <div class="hud">
        <div class="pill">Score : <span id="score">0</span></div>
        <div class="pill">Vitesse : <span id="speed">1.0√ó</span></div>
        <div class="pill">Record : <span id="bestHud">0</span></div>
      </div>
    </div>

    <div class="stage">
      <canvas id="game" width="480" height="480" aria-label="Jeu Snake"></canvas>
    </div>

    <div class="bottom">
      <div class="actionsRow" aria-label="Actions">
        <button class="iconBtn" id="pauseBtn" aria-label="Pause">
          <div class="icon">‚è∏</div><div class="iconLabel">Pause</div>
        </button>
        <button class="iconBtn" id="fsBtnSmall" aria-label="Plein √©cran">
          <div class="icon">‚õ∂</div><div class="iconLabel">Plein √©cran</div>
        </button>
        <button class="iconBtn" id="startSmall" aria-label="D√©marrer">
          <div class="icon">‚ñ∂</div><div class="iconLabel">D√©marrer</div>
        </button>
        <button class="iconBtn primary" id="restartSmall" aria-label="Recommencer">
          <div class="icon">‚Üª</div><div class="iconLabel">Rejouer</div>
        </button>
      </div>

      <div class="dpadBig" aria-label="Contr√¥les directionnels">
        <div></div>
        <button id="upBtn" aria-label="Haut">‚ñ≤</button>
        <div></div>
        <button id="leftBtn" aria-label="Gauche">‚óÄ</button>
        <button id="noopBtn" disabled aria-label="Centre">‚óè</button>
        <button id="rightBtn" aria-label="Droite">‚ñ∂</button>
        <div></div>
        <button id="downBtn" aria-label="Bas">‚ñº</button>
        <div></div>
      </div>

      <div class="hint">Murs = perdu ‚Ä¢ Contr√¥les XXL ‚Ä¢ Sons arcade ‚Ä¢ Record sauvegard√© ‚Ä¢ Message pour Mireille</div>
    </div>

    <div class="overlay" id="startOverlay">
      <div class="modal">
        <div style="font-size:42px; line-height:1;">üêç</div>
        <h2>Snake ‚Äî pr√™t ?</h2>
        <p>Contr√¥les grands + mode portrait.</p>
        <div class="btnRow">
          <button class="bigBtn" id="fsBtn">‚õ∂ Plein √©cran</button>
          <button class="bigBtn primary" id="startBtn">‚ñ∂ D√©marrer</button>
        </div>
        <p style="margin-top:10px; font-size:12px; color:var(--muted);">
          Sur certains navigateurs (iOS), le plein √©cran peut √™tre limit√©.
        </p>
      </div>
    </div>

    <div class="overlay" id="overOverlay">
      <div class="modal">
        <div style="font-size:36px; line-height:1;">üíÄ</div>
        <h2>Game Over</h2>
        <div class="bigScore" id="finalScore">0</div>
        <p>Score final</p>

        <div class="recordLine" id="recordLine">
          üèÜ Record : <b><span id="bestOver">0</span></b>
          <span style="opacity:.8;">‚Ä¢</span>
          √Ä battre : <b><span id="toBeat">0</span></b>
        </div>

        <div class="encourage" id="encourageMsg"></div>
        <div class="btnRow">
          <button class="bigBtn primary" id="restartBtn">‚Üª Recommencer</button>
          <button class="bigBtn" id="closeOverBtn">Voir le plateau</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const appRoot = document.getElementById("appRoot");

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");

      const scoreEl = document.getElementById("score");
      const speedEl = document.getElementById("speed");
      const bestHudEl = document.getElementById("bestHud");

      const startOverlay = document.getElementById("startOverlay");
      const overOverlay = document.getElementById("overOverlay");
      const finalScoreEl = document.getElementById("finalScore");
      const encourageMsgEl = document.getElementById("encourageMsg");
      const bestOverEl = document.getElementById("bestOver");
      const toBeatEl = document.getElementById("toBeat");

      const startBtn = document.getElementById("startBtn");
      const startSmall = document.getElementById("startSmall");
      const fsBtn = document.getElementById("fsBtn");
      const fsBtnSmall = document.getElementById("fsBtnSmall");
      const pauseBtn = document.getElementById("pauseBtn");
      const restartBtn = document.getElementById("restartBtn");
      const restartSmall = document.getElementById("restartSmall");
      const closeOverBtn = document.getElementById("closeOverBtn");

      const upBtn = document.getElementById("upBtn");
      const downBtn = document.getElementById("downBtn");
      const leftBtn = document.getElementById("leftBtn");
      const rightBtn = document.getElementById("rightBtn");

      // ====== Best score persistence ======
      const BEST_KEY = "snake_best_score_v1";
      function loadBest() {
        const v = Number(localStorage.getItem(BEST_KEY));
        return Number.isFinite(v) && v >= 0 ? Math.floor(v) : 0;
      }
      function saveBest(v) {
        localStorage.setItem(BEST_KEY, String(Math.max(0, Math.floor(v))));
      }
      let bestScore = loadBest();
      bestHudEl.textContent = bestScore;

      // ====== SFX (no files) ======
      let audioCtx = null;

      function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }

      function beep({freq=440, dur=0.08, type="square", vol=0.08, freqEnd=null} = {}) {
        if (!audioCtx) return;
        const t0 = audioCtx.currentTime;

        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();

        o.type = type;
        o.frequency.setValueAtTime(freq, t0);
        if (freqEnd !== null) {
          o.frequency.exponentialRampToValueAtTime(Math.max(1, freqEnd), t0 + dur);
        }

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(vol, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

        o.connect(g);
        g.connect(audioCtx.destination);

        o.start(t0);
        o.stop(t0 + dur + 0.01);
      }

      const SFX = {
        click() { beep({freq:700, dur:0.05, type:"square", vol:0.05, freqEnd:500}); },
        apple() { beep({freq:1100, dur:0.07, type:"square", vol:0.08, freqEnd:1600}); },
        turn()  { beep({freq:520, dur:0.03, type:"square", vol:0.03, freqEnd:430}); },
        best()  { // little victory jingle
          beep({freq:880, dur:0.07, type:"square", vol:0.08, freqEnd:1320});
          setTimeout(()=>beep({freq:1320, dur:0.09, type:"square", vol:0.08, freqEnd:1760}), 70);
        },
        death() {
          beep({freq:420, dur:0.10, type:"sawtooth", vol:0.09, freqEnd:160});
          setTimeout(()=>beep({freq:240, dur:0.12, type:"square", vol:0.08, freqEnd:90}), 90);
        },
      };

      function unlockAudioFromUserGesture() {
        initAudio();
        if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
      }

      // ====== Encouragements for Mireille ======
      const MIREILLE_MESSAGES = [
        "Mireille, c‚Äô√©tait une belle tentative ! La prochaine pomme est pour toi üçé",
        "Allez Mireille, on respire‚Ä¶ et on repart ! Tu vas y arriver üí™",
        "Mireille, tu progresses ! Chaque partie te rend plus forte üêç",
        "Bravo Mireille : m√™me quand on perd, on apprend. Rejoue ! ‚ú®",
        "Mireille, pas grave ! Le snake a juste fait sa diva üòÑ Recommence !",
        "Mireille, joli score ! Encore une et tu bats ton record üèÜ",
        "Courage Mireille : une petite pause‚Ä¶ puis un grand comeback üöÄ",
        "Mireille, tu g√®res ! La prochaine partie sera la bonne üî•",
        "Mireille, focus : doucement au d√©but, ensuite tu acc√©l√®res üòé",
        "Mireille, tu es plus maligne que ces murs. Revanche ! üòÅ"
      ];
      let lastMsgIndex = -1;
      function pickMireilleMessage() {
        if (MIREILLE_MESSAGES.length === 1) return MIREILLE_MESSAGES[0];
        let i;
        do { i = Math.floor(Math.random() * MIREILLE_MESSAGES.length); }
        while (i === lastMsgIndex);
        lastMsgIndex = i;
        return MIREILLE_MESSAGES[i];
      }

      // ---- Game config ----
      const GRID = 20;
      const BASE_TICK_MS = 145;
      const SPEED_UP_PER_APPLE = 0.93;
      const MIN_TICK_MS = 55;

      let snake, dir, nextDir, apple, score, tickMs, running, paused, lastTime, acc;

      function randCell() {
        return { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
      }
      function cellEquals(a,b){ return a.x===b.x && a.y===b.y; }

      function resizeCanvasForPortrait() {
        const stage = canvas.parentElement;
        const w = stage.clientWidth;
        const internal = GRID * 24; // 480
        canvas.width = internal;
        canvas.height = internal;

        const sizeCSS = Math.min(w, stage.clientHeight, 520);
        canvas.style.width = sizeCSS + "px";
        canvas.style.height = sizeCSS + "px";
      }

      function placeApple() {
        let c;
        do { c = randCell(); } while (snake.some(seg => cellEquals(seg, c)));
        apple = c;
      }

      function setSpeedHud() {
        const mult = (BASE_TICK_MS / tickMs);
        speedEl.textContent = mult.toFixed(1) + "√ó";
      }

      function showStart() { startOverlay.style.display = "flex"; }
      function hideStart() { startOverlay.style.display = "none"; }
      function showGameOver() { overOverlay.style.display = "flex"; }
      function hideGameOver() { overOverlay.style.display = "none"; }

      function resetGameState() {
        const start = { x: Math.floor(GRID/2), y: Math.floor(GRID/2) };
        snake = [
          { x: start.x, y: start.y },
          { x: start.x-1, y: start.y },
          { x: start.x-2, y: start.y },
        ];
        dir = { x: 0, y: 1 };
        nextDir = { x: 0, y: 1 };
        score = 0;
        tickMs = BASE_TICK_MS;
        paused = false;
        lastTime = 0;
        acc = 0;

        scoreEl.textContent = score;
        setSpeedHud();
        placeApple();
      }

      function resetGame(showStartScreen = true) {
        resetGameState();
        running = false;
        hideGameOver();
        setPauseBtnLabel(false);
        render();
        if (showStartScreen) showStart();
        else hideStart();
      }

      function setPauseBtnLabel(isPaused) {
        if (isPaused) {
          pauseBtn.innerHTML = '<div class="icon">‚ñ∂</div><div class="iconLabel">Reprendre</div>';
        } else {
          pauseBtn.innerHTML = '<div class="icon">‚è∏</div><div class="iconLabel">Pause</div>';
        }
      }

      function startGame() {
        unlockAudioFromUserGesture();
        SFX.click();
        hideStart();
        hideGameOver();
        running = true;
        paused = false;
        setPauseBtnLabel(false);
      }

      function updateBestIfNeeded() {
        if (score > bestScore) {
          bestScore = score;
          saveBest(bestScore);
          bestHudEl.textContent = bestScore;
          SFX.best();
          return true;
        }
        return false;
      }

      function gameOver() {
        running = false;
        paused = false;
        setPauseBtnLabel(false);

        const newRecord = updateBestIfNeeded();

        finalScoreEl.textContent = score;
        bestOverEl.textContent = bestScore;
        toBeatEl.textContent = bestScore + 1;
        encourageMsgEl.textContent = newRecord
          ? "Mireille, NOUVEAU RECORD ! Magnifique üéâ Recommence pour le pulv√©riser !"
          : pickMireilleMessage();

        showGameOver();
        if (!newRecord) SFX.death();
      }

      function trySetDir(nx, ny) {
        if (nx === -dir.x && ny === -dir.y) return;
        nextDir = { x: nx, y: ny };
        if (running && !paused) SFX.turn();
      }

      function step() {
        dir = nextDir;
        const head = snake[0];
        const newHead = { x: head.x + dir.x, y: head.y + dir.y };

        if (newHead.x < 0 || newHead.x >= GRID || newHead.y < 0 || newHead.y >= GRID) return gameOver();
        if (snake.some(seg => cellEquals(seg, newHead))) return gameOver();

        snake.unshift(newHead);

        if (cellEquals(newHead, apple)) {
          score += 1;
          scoreEl.textContent = score;
          SFX.apple();
          tickMs = Math.max(MIN_TICK_MS, Math.floor(tickMs * SPEED_UP_PER_APPLE));
          setSpeedHud();
          placeApple();
        } else {
          snake.pop();
        }
      }

      function clear() { ctx.clearRect(0,0,canvas.width,canvas.height); }

      function drawGrid() {
        const cell = canvas.width / GRID;
        ctx.save();
        ctx.globalAlpha = 0.12;
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 1;
        for (let i = 1; i < GRID; i++) {
          ctx.beginPath(); ctx.moveTo(i*cell, 0); ctx.lineTo(i*cell, canvas.height); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(0, i*cell); ctx.lineTo(canvas.width, i*cell); ctx.stroke();
        }
        ctx.restore();
      }

      function drawCell(x,y,fill,stroke){
        const cell = canvas.width / GRID;
        const px = x*cell, py = y*cell;
        ctx.fillStyle = fill;
        ctx.fillRect(px+1, py+1, cell-2, cell-2);
        if (stroke){
          ctx.strokeStyle = stroke;
          ctx.lineWidth = 2;
          ctx.strokeRect(px+2, py+2, cell-4, cell-4);
        }
      }

      function render() {
        clear();
        drawGrid();
        drawCell(apple.x, apple.y, "rgba(255,90,90,.90)", "rgba(255,255,255,.15)");

        for (let i = snake.length - 1; i >= 0; i--) {
          const s = snake[i];
          if (i === 0) drawCell(s.x, s.y, "rgba(120,255,170,.95)", "rgba(255,255,255,.18)");
          else drawCell(s.x, s.y, "rgba(120,255,170,.70)", "rgba(0,0,0,.12)");
        }

        if (paused && running) {
          ctx.save();
          ctx.fillStyle = "rgba(0,0,0,.45)";
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = "#ffffff";
          ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "center";
          ctx.fillText("PAUSE", canvas.width/2, canvas.height/2);
          ctx.restore();
        }
      }

      function loop(t){
        if (!lastTime) lastTime = t;
        const dt = t - lastTime;
        lastTime = t;

        if (running && !paused) {
          acc += dt;
          while (acc >= tickMs) {
            acc -= tickMs;
            step();
            if (!running) break;
          }
        }
        render();
        requestAnimationFrame(loop);
      }

      async function toggleFullscreen() {
        unlockAudioFromUserGesture();
        SFX.click();
        try {
          if (!document.fullscreenElement) {
            await appRoot.requestFullscreen?.();
          } else {
            await document.exitFullscreen?.();
          }
        } catch (e) {
          alert("Plein √©cran non disponible sur ce navigateur.\nAstuce: sur iPhone, essaye 'Ajouter √† l‚Äô√©cran d‚Äôaccueil'.");
        }
      }

      function bindPress(btn, fn){
        const start = (ev) => { ev.preventDefault(); unlockAudioFromUserGesture(); fn(); };
        btn.addEventListener("pointerdown", start, { passive:false });
      }
      bindPress(upBtn,   () => trySetDir(0,-1));
      bindPress(downBtn, () => trySetDir(0, 1));
      bindPress(leftBtn, () => trySetDir(-1,0));
      bindPress(rightBtn,() => trySetDir(1, 0));

      startBtn.addEventListener("click", startGame);
      startSmall.addEventListener("click", startGame);

      fsBtn.addEventListener("click", toggleFullscreen);
      fsBtnSmall.addEventListener("click", toggleFullscreen);

      pauseBtn.addEventListener("click", () => {
        unlockAudioFromUserGesture();
        SFX.click();
        if (!running) return;
        paused = !paused;
        setPauseBtnLabel(paused);
      });

      function doRestartImmediate() {
        unlockAudioFromUserGesture();
        SFX.click();
        resetGame(false);
        startGame();
      }
      restartBtn.addEventListener("click", doRestartImmediate);
      restartSmall.addEventListener("click", doRestartImmediate);

      closeOverBtn.addEventListener("click", () => {
        unlockAudioFromUserGesture();
        SFX.click();
        overOverlay.style.display = "none";
      });

      window.addEventListener("resize", resizeCanvasForPortrait);
      window.addEventListener("orientationchange", resizeCanvasForPortrait);

      setTimeout(() => {
        resizeCanvasForPortrait();
        resetGame(true);
        requestAnimationFrame(loop);
      }, 0);
    })();
  </script>
</body>
</html>
